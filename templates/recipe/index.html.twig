{# templates/recipe/index.html.twig #}
{% extends 'base.html.twig' %}
{% set hide_global_search = true %}

{% block title %}üçä Recettes Orange Chef{% endblock %}

{% block body %}
    <div class="container">
        <div class="recipe-header">
            <h1>üçä Toutes nos Recettes</h1>
            <p>D√©couvrez des recettes d√©licieuses √† base d'oranges !</p>

            {% if app.user %}
                <a href="{{ path('app_recipe_new') }}" class="btn btn-primary">‚ûï Cr√©er une recette</a>
            {% endif %}
        </div>

        {# Filtres #}
        <div class="recipe-filters">
            {% set _diff = current_difficulty in ['moyen','moyenne'] ? 'moyenne' : current_difficulty %}
            {% set _qval = current_search ?? app.request.get('q') ?? app.request.get('search') %}
            {# ‚ö†Ô∏è le contr√¥leur lit ps, pas per_page #}
            {% set _per = page_size ?? app.request.get('ps')|default(12) %}

            <form action="{{ path('app_recipe_index', {'_locale': app.request.locale}) }}" method="get" class="filters-form">
                <div class="filter-row">
                    {# ‚ö†Ô∏è le contr√¥leur lit p, pas page #}
                    <input type="hidden" name="p" value="1">

                    <div class="filter-group">
                        <input type="text" name="q" value="{{ _qval }}" class="form-control search-input"
                               placeholder="Rechercher une recette, une cat√©gorie, une vari√©t√©‚Ä¶" style="max-width:320px">
                    </div>

                    <div class="filter-group">
                        <select name="category" class="form-select" onchange="this.form.submit()">
                            <option value="">Toutes cat√©gories</option>
                            {% if categories is defined and categories is not empty %}
                                {% for c in categories %}
                                    <option value="{{ c }}" {{ current_category == c ? 'selected' : '' }}>{{ c|title }}</option>
                                {% endfor %}
                            {% else %}
                                <option value="dessert"   {{ current_category == 'dessert'   ? 'selected' : '' }}>üç∞ Dessert</option>
                                <option value="boisson"   {{ current_category == 'boisson'   ? 'selected' : '' }}>ü•§ Boisson</option>
                                <option value="plat"      {{ current_category == 'plat'      ? 'selected' : '' }}>üçΩÔ∏è Plat</option>
                                <option value="sauce"     {{ current_category == 'sauce'     ? 'selected' : '' }}>ü•Ñ Sauce</option>
                                <option value="confiture" {{ current_category == 'confiture' ? 'selected' : '' }}>üçØ Confiture</option>
                                <option value="salade"    {{ current_category == 'salade'    ? 'selected' : '' }}>ü•ó Salade</option>
                            {% endif %}
                        </select>
                    </div>

                    <div class="filter-group">
                        <select name="difficulty" class="form-select" onchange="this.form.submit()">
                            <option value="">Toute difficult√©</option>
                            <option value="facile"     {{ _diff == 'facile'     ? 'selected' : '' }}>‚≠ê Facile</option>
                            <option value="moyenne"    {{ _diff == 'moyenne'    ? 'selected' : '' }}>‚≠ê‚≠ê Moyenne</option>
                            <option value="difficile"  {{ _diff == 'difficile'  ? 'selected' : '' }}>‚≠ê‚≠ê‚≠ê Difficile</option>
                        </select>
                    </div>

                    <div class="filter-group">
                        <select name="sort" class="form-select" onchange="this.form.submit()">
                            <option value="newest" {{ sort == 'newest' ? 'selected' : '' }}>üÜï Plus r√©centes</option>
                            <option value="oldest" {{ sort == 'oldest' ? 'selected' : '' }}>üóìÔ∏è Plus anciennes</option>
                            <option value="title"  {{ sort == 'title'  ? 'selected' : '' }}>üî§ Titre (A‚ÜíZ)</option>
                        </select>
                    </div>

                    {# ‚ñº par page (le contr√¥leur lit ps) ‚ñº #}
                    <div class="filter-group">
                        <select name="ps" class="form-select" onchange="this.form.submit()">
                            {% for n in [10,20,50] %}
                                <option value="{{ n }}" {{ _per == n ? 'selected' : '' }}>{{ n }} / page</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="filter-group">
                        <button type="submit" class="btn btn-primary">Filtrer</button>
                        <a href="{{ path('app_recipe_index', {'_locale': app.request.locale}) }}" class="btn btn-outline-secondary">Effacer</a>
                    </div>
                </div>
            </form>

            {% if _qval %}
                <p class="muted mt-2">R√©sultats pour ¬´ <strong>{{ _qval }}</strong> ¬ª</p>
            {% endif %}
        </div>

        {# Grille #}
        <div class="recipes-grid">
            {% for recipe in recipes %}
                <div class="recipe-card" data-card-index="{{ loop.index0 }}">
                    <div class="recipe-image">
                        {% set img = recipe.image %}
                        {% if img %}
                            {% set imgNoSlash = img starts with '/' ? img|slice(1) : img %}
                            {% if imgNoSlash starts with 'uploads/' %}
                                <img loading="lazy" decoding="async" src="{{ asset(imgNoSlash) }}" alt="{{ recipe.title }}">
                            {% else %}
                                <img loading="lazy" decoding="async" src="{{ asset('uploads/recipes/' ~ imgNoSlash) }}" alt="{{ recipe.title }}">
                            {% endif %}
                        {% else %}
                            {% set cat = (recipe.category ?? '')|lower %}
                            {% set fallback = null %}
                            {% if 'dessert' in cat %}{% set fallback = 'tarte.jpg' %}
                            {% elseif 'boisson' in cat %}{% set fallback = 'jus.jpg' %}
                            {% elseif 'salade'  in cat %}{% set fallback = 'salade.jpg' %}
                            {% elseif 'plat'    in cat %}{% set fallback = 'poulet.jpg' %}
                            {% endif %}
                            {% if not fallback %}
                                {% set title_lc = (recipe.title ?? '')|lower %}
                                {% if 'tarte' in title_lc %}{% set fallback = 'tarte.jpg' %}
                                {% elseif 'jus' in title_lc %}{% set fallback = 'jus.jpg' %}
                                {% elseif 'salade' in title_lc %}{% set fallback = 'salade.jpg' %}
                                {% elseif 'poulet' in title_lc %}{% set fallback = 'poulet.jpg' %}
                                {% endif %}
                            {% endif %}
                            {% if fallback %}
                                <img loading="lazy" decoding="async" src="{{ asset('uploads/recipes/' ~ fallback) }}" alt="{{ recipe.title }}">
                            {% else %}
                                <div class="recipe-placeholder">üçä</div>
                            {% endif %}
                        {% endif %}

                        <div class="recipe-badges">
                            <span class="badge badge-chef">{{ recipe.categoryIcon }}</span>
                            <span class="badge badge-bronze">{{ recipe.difficultyIcon }}</span>
                        </div>
                    </div>

                    <div class="recipe-content">
                        <h3><a href="{{ path('app_recipe_show', {id: recipe.id}) }}">{{ recipe.title }}</a></h3>
                        {% set desc = recipe.description ?? '' %}
                        <p class="recipe-description">{{ desc|length > 100 ? desc|slice(0, 100) ~ '‚Ä¶' : desc }}</p>

                        {# ‚≠ê meta compacte : √©toiles + (n) ne cassent plus #}
                        <div class="recipe-meta rc-meta">
                            <div class="recipe-stats rc-stats">
                                <span>‚è±Ô∏è {{ recipe.totalTime }}min</span>
                                <span>üë• {{ recipe.servings }} pers.</span>
                                <span>üëÅÔ∏è {{ recipe.views }}</span>
                            </div>

                            <div class="recipe-rating rc-item">
                                {% set avg = (recipe.averageRating|default(0))|round(0, 'floor') %}
                                {% if avg > 0 %}
                                    <span class="rc-stars" aria-label="{{ avg }}/5">
                  {% for i in 1..5 %}
                      <span class="{{ i <= avg ? '' : 'off' }}">‚òÖ</span>
                  {% endfor %}
                </span>
                                    <small class="muted">({{ recipe.ratings|length }})</small>
                                {% else %}
                                    <span class="no-rating">Pas encore not√©</span>
                                {% endif %}
                            </div>
                        </div>

                        <div class="recipe-actions">
                            {% if app.user and recipe.author and recipe.author == app.user %}
                                <a class="btn btn-small" href="{{ path('app_recipe_edit', {id: recipe.id}) }}">‚úèÔ∏è Modifier</a>
                            {% endif %}
                            <a class="btn btn-secondary btn-small" href="{{ path('app_recipe_show', {id: recipe.id}) }}">üëÄ Voir</a>
                        </div>

                        <div class="recipe-author"><small>Par {{ recipe.author.displayName }}</small></div>
                    </div>
                </div>
            {% else %}
                <div class="no-recipes">
                    <div class="empty-state">
                        <h3>üçä Aucune recette trouv√©e</h3>
                        <p>Soyez le premier √† partager une d√©licieuse recette √† l'orange !</p>
                        {% if app.user %}
                            <a href="{{ path('app_recipe_new') }}" class="btn btn-primary">Cr√©er ma premi√®re recette</a>
                        {% endif %}
                    </div>
                </div>
            {% endfor %}
        </div>

        {# Pagination (inchang√©e sauf les bons noms d‚Äôargs d√©j√† pr√©sents) #}
        {% if total_pages > 1 %}
            {% set window = 2 %}
            {% set start = page - window %}
            {% set end   = page + window %}
            {% set start = start < 1 ? 1 : start %}
            {% set end   = end > total_pages ? total_pages : end %}

            <nav class="pagination" role="navigation" aria-label="Pagination">
                <a class="page-btn prev {{ page == 1 ? 'is-disabled' : '' }}"
                   href="{{ path('app_recipe_index', {_locale: app.request.locale, p: page > 1 ? page - 1 : 1, ps: page_size, sort: sort, category: current_category, difficulty: current_difficulty, search: current_search }) }}"
                   aria-disabled="{{ page == 1 ? 'true' : 'false' }}">‚üµ Pr√©c√©dent</a>

                <div class="page-numbers">
                    {% if start > 1 %}
                        <a class="page" href="{{ path('app_recipe_index', {_locale: app.request.locale, p: 1, ps: page_size, sort: sort, category: current_category, difficulty: current_difficulty, search: current_search }) }}">1</a>
                        {% if start > 2 %}<span class="dots">‚Ä¶</span>{% endif %}
                    {% endif %}

                    {% for pnum in start..end %}
                        {% if pnum == page %}
                            <span class="page current" aria-current="page">{{ pnum }}</span>
                        {% else %}
                            <a class="page" href="{{ path('app_recipe_index', {_locale: app.request.locale, p: pnum, ps: page_size, sort: sort, category: current_category, difficulty: current_difficulty, search: current_search }) }}">{{ pnum }}</a>
                        {% endif %}
                    {% endfor %}

                    {% if end < total_pages %}
                        {% if end < total_pages - 1 %}<span class="dots">‚Ä¶</span>{% endif %}
                        <a class="page" href="{{ path('app_recipe_index', {_locale: app.request.locale, p: total_pages, ps: page_size, sort: sort, category: current_category, difficulty: current_difficulty, search: current_search }) }}">{{ total_pages }}</a>
                    {% endif %}
                </div>

                <a class="page-btn next {{ page == total_pages ? 'is-disabled' : '' }}"
                   href="{{ path('app_recipe_index', {_locale: app.request.locale, p: page < total_pages ? page + 1 : total_pages, ps: page_size, sort: sort, category: current_category, difficulty: current_difficulty, search: current_search }) }}"
                   aria-disabled="{{ page == total_pages ? 'true' : 'false' }}">Suivant ‚ü∂</a>
            </nav>

            <p class="page-summary">Page {{ page }} / {{ total_pages }} ‚Äî {{ total }} r√©sultats</p>
        {% endif %}
    </div>

    {# --- CSS local (d√©place-le ensuite dans theme-citrus.css) --- #}
    <style>
        .filters-form .filter-row{display:flex;flex-wrap:wrap;gap:12px;align-items:center;margin-bottom:12px}
        .filters-form .filter-group{display:flex;align-items:center;gap:8px}
        .filters-form .search-input{min-width:220px}

        .recipes-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(350px,1fr));gap:25px}
        .recipe-card{background:#fff;border-radius:15px;overflow:hidden;box-shadow:0 4px 15px rgba(0,0,0,.1);transition:.3s cubic-bezier(.4,0,.2,1)}
        .recipe-card:hover{transform:translateY(-8px);box-shadow:0 12px 30px rgba(0,0,0,.15)}
        .recipe-image{height:200px;position:relative;overflow:hidden}
        .recipe-image img{width:100%;height:100%;object-fit:cover;transition:transform .3s ease}
        .recipe-card:hover .recipe-image img{transform:scale(1.05)}
        .recipe-placeholder{display:flex;align-items:center;justify-content:center;width:100%;height:100%;background:linear-gradient(135deg,#ff9800,#f57c00);font-size:4em;color:#fff}
        .recipe-badges{position:absolute;top:10px;right:10px;display:flex;gap:5px}

        .recipe-content{padding:20px}
        .recipe-description{color:#666;font-size:14px;margin-bottom:15px;line-height:1.4}

        /* ‚Äî‚Äî meta compacte + √©toiles qui ne cassent pas ‚Äî‚Äî */
        .rc-meta{display:flex;align-items:center;justify-content:space-between;gap:14px;margin-bottom:10px;font-size:13px}
        .rc-stats{display:flex;gap:15px;color:#666;flex-wrap:wrap}
        .rc-item{display:flex;align-items:center;gap:6px;white-space:nowrap}
        .rc-stars{display:inline-flex;gap:2px;white-space:nowrap;line-height:1;vertical-align:middle;font-size:14px;color:#ff9800}
        .rc-stars .off{opacity:.35}
        .no-rating{color:#6b7280;white-space:nowrap}

        .recipe-actions{display:flex;gap:8px;margin-top:8px}
        .btn{background:linear-gradient(135deg,#ff9800,#f57c00);color:#fff;padding:8px 12px;border-radius:8px;text-decoration:none}
        .btn-secondary{background:#fff;color:#ff9800;border:2px solid #ff9800}
        .btn-secondary:hover{background:#ff9800;color:#fff}
        .btn-small{padding:6px 10px;font-size:13px}

        @media (max-width:768px){
            .recipes-grid{grid-template-columns:1fr}
            .filter-row{flex-direction:column}
            .filter-group{width:100%}
        }

        /* pagination (inchang√©) */
        .pagination{display:flex;align-items:center;justify-content:center;gap:12px;margin:28px 0;flex-wrap:wrap}
        .page-numbers{display:flex;gap:8px}
        .page-btn,.page-numbers .page{display:inline-flex;align-items:center;justify-content:center;min-width:40px;height:40px;padding:0 14px;border-radius:10px;border:1px solid #ffe3c6;background:#fff;text-decoration:none;color:#1f2937;font-weight:600;box-shadow:0 1px 0 rgba(16,24,40,.06);transition:transform .12s,box-shadow .12s,background .12s,border-color .12s}
        .page-btn:hover,.page-numbers .page:hover{transform:translateY(-1px);border-color:#ffc78f;background:#fffdf9;box-shadow:0 6px 16px rgba(255,152,0,.12)}
        .page-numbers .current{background:#fff3e0;border-color:#ff9800;color:#1f2937;font-weight:800;cursor:default;box-shadow:inset 0 1px 0 rgba(255,152,0,.15),0 6px 14px rgba(255,152,0,.10)}
        .page-btn.is-disabled,[aria-disabled="true"]{opacity:.45;pointer-events:none}
        .dots{padding:0 6px;color:#9aa3b2;user-select:none}
        .page-summary{text-align:center;margin:4px 0 0;color:#6b7280;font-size:.9rem}
    </style>

    {# JS compacte densit√© (optionnel ‚Äî safe si le bouton n‚Äôexiste pas) #}
    <script>
        (function(){
            const container = document.currentScript.closest('.container');
            const densityBtn = container.querySelector('#densityToggle');
            densityBtn?.addEventListener('click', () => {
                const pressed = densityBtn.getAttribute('aria-pressed') === 'true';
                const next = !pressed;
                densityBtn.setAttribute('aria-pressed', String(next));
                densityBtn.textContent = next ? 'Mode confortable' : 'Mode compact';
                container.classList.toggle('compact', next);
            });
        })();
    </script>
{% endblock %}
