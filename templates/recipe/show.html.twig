{% extends 'base.html.twig' %}

{% block title %}{{ recipe.title }} - Orange Chef{% endblock %}

{% block meta %}
    {# URLs absolues #}
    {% set pageUrl  = absolute_url(path('app_recipe_show', { id: recipe.id })) %}
    {% set imageUrl = recipe.image
        ? absolute_url(asset('uploads/recipes/' ~ recipe.image))
        : absolute_url(asset('images/og-default.jpg')) %}

    {# Description courte et propre #}
    {% set rawDesc = recipe.description|default('') %}
    {% set desc    = (rawDesc|striptags)|u.truncate(160, '‚Ä¶') %}

    <link rel="canonical" href="{{ pageUrl }}">
    <meta property="og:type" content="article">
    <meta property="og:title" content="{{ recipe.title }}">
    <meta property="og:description" content="{{ desc }}">
    <meta property="og:url" content="{{ pageUrl }}">
    <meta property="og:image" content="{{ imageUrl }}">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="{{ recipe.title }}">
    <meta name="twitter:description" content="{{ desc }}">
    <meta name="twitter:image" content="{{ imageUrl }}">

    {# Normalisation des listes pour le JSON-LD (string -> array par \n) #}
    {% set rawIngredients = recipe.ingredients|default('') %}
    {% set ingredients    = rawIngredients is iterable ? rawIngredients : rawIngredients|split('\n')|filter(v => v|trim != '') %}

    {% set rawSteps = recipe.instructions|default('') %}
    {% set steps    = rawSteps is iterable ? rawSteps : rawSteps|split('\n')|filter(v => v|trim != '') %}

    <script type="application/ld+json">
        {
          "@context": "https://schema.org",
          "@type": "Recipe",
          "name": {{ recipe.title|e('js') }},
      "description": {{ recipe.description|default('')|striptags|e('js') }},
      "image": [{{ imageUrl|e('js') }}],
      "recipeIngredient": [{% for i in ingredients %}{{ i|e('js') }}{% if not loop.last %}, {% endif %}{% endfor %}],
      "recipeInstructions": [
        {% for s in steps %}
          {"@type":"HowToStep","text":{{ s|striptags|e('js') }}}
          {% if not loop.last %},{% endif %}
        {% endfor %}
        ]
      }
    </script>
{% endblock %}

{% block body %}

      {% set _ingredients = ingredients|default([]) %}
      {% set _steps = steps|default([]) %}


      <div class="container">
        <div class="recipe-detail">
            <!-- En-t√™te recette -->
            <div class="recipe-header">
                <div class="recipe-image-large">
                    {% if recipe.image %}
                        {% set img = recipe.image %}
                        {% if img starts with 'http' or img starts with 'https' %}
                            {% set src = img %}
                        {% elseif img starts with 'uploads/' %}
                            {% set src = asset(img) %}
                        {% elseif img starts with '/uploads/' %}
                            {% set src = img %}
                        {% else %}
                            {% set src = asset('uploads/recipes/' ~ img) %}
                        {% endif %}
                        <img src="{{ src }}" alt="{{ recipe.title }}" loading="lazy" width="900" height="600">
                    {% else %}
                        <div class="recipe-placeholder-large">üçä</div>
                    {% endif %}

                    <div class="recipe-overlay">
                        <div class="recipe-badges">
                            <span class="badge badge-chef">{{ recipe.categoryIcon }} {{ recipe.category|title }}</span>
                            <span class="badge badge-bronze">{{ recipe.difficultyIcon }} {{ recipe.difficulty|title }}</span>
                        </div>
                    </div>
                </div>

                <div class="recipe-info">
                    <h1>{{ recipe.title }}</h1>
                    <p class="recipe-description">{{ recipe.description }}</p>

                    <div class="recipe-meta-large">
                        <div class="meta-item">
                            <span class="meta-icon">‚è±Ô∏è</span>
                            <div><strong>{{ recipe.totalTime }} min</strong><small>Total</small></div>
                        </div>
                        <div class="meta-item">
                            <span class="meta-icon">üë•</span>
                            <div><strong>{{ recipe.servings }}</strong><small>Portions</small></div>
                        </div>
                        <div class="meta-item">
                            <span class="meta-icon">üëÅÔ∏è</span>
                            <div><strong>{{ recipe.views }}</strong><small>Vues</small></div>
                        </div>
                        <div class="meta-item">
                            <span class="meta-icon">‚≠ê</span>
                            <div>
                                <strong>{{ avgApproved > 0 ? avgApproved : 'N/A' }}</strong>
                                <small>Note ({{ countApproved }})</small>
                            </div>
                        </div>
                    </div>

                    <div class="recipe-author-info">
                        <span>Par <strong>{{ recipe.author.displayName }}</strong></span>
                        <span class="recipe-date">{{ recipe.createdAt|date('d/m/Y') }}</span>
                    </div>

                    {% if app.user %}
                        <div class="mt-2">
                            <form method="post" action="{{ path('app_favorite_toggle', {id: recipe.id}) }}" style="display:inline">
                                <input type="hidden" name="_token" value="{{ csrf_token('fav_' ~ recipe.id) }}">
                                <button type="submit" class="btn {{ isFav ? 'btn-secondary' : 'btn-primary' }}">
                                    {{ isFav ? 'üíî Retirer des favoris' : '‚ù§Ô∏è Ajouter aux favoris' }}
                                </button>
                            </form>
                        </div>
                    {% endif %}
                </div>
            </div>

            {# Actions auteur/admin #}
            {% if app.user %}
                <div class="recipe-actions">
                    {% if app.user == recipe.author or is_granted('ROLE_ADMIN') %}
                        <a href="{{ path('app_recipe_edit', {id: recipe.id}) }}" class="btn btn-secondary">‚úèÔ∏è Modifier</a>
                        <form method="post" action="{{ path('app_recipe_delete', {id: recipe.id}) }}" style="display:inline">
                            <input type="hidden" name="_token" value="{{ csrf_token('delete' ~ recipe.id) }}">
                            <button type="submit" class="btn btn-danger" onclick="return confirm('√ätes-vous s√ªr de vouloir supprimer cette recette ?')">üóëÔ∏è Supprimer</button>
                        </form>
                    {% endif %}
                </div>
            {% endif %}

            <!-- Contenu principal -->
            <div class="recipe-content">
                <div class="recipe-ingredients">
                    <h2>ü•Ñ Ingr√©dients</h2>
                    <div class="ingredients-list">
                        {% for line in _ingredients %}
                            {% if line|trim %}
                                <div class="ingredient-item">
                                    <span class="ingredient-bullet">üçä</span>{{ line|trim }}
                                </div>
                            {% endif %}
                        {% endfor %}
                    </div>
                </div>

                <div class="recipe-instructions">
                    <h2>üë®‚Äçüç≥ Instructions</h2>
                    <div class="instructions-list">
                        {% set stepNumber = 1 %}
                        {% for line in _steps %}
                            {% if line|trim %}
                                <div class="instruction-step">
                                    <div class="step-number">{{ stepNumber }}</div>
                                    <div class="step-content">{{ line|trim }}</div>
                                </div>
                                {% set stepNumber = stepNumber + 1 %}
                            {% endif %}
                        {% endfor %}
                    </div>
                </div>
            </div>

            {# Partage #}
            {% include '_partials/share.html.twig' with { recipe: recipe } %}

            <!-- Notes & avis -->
            <section class="review-section mt-4" id="reviews">
                <h2>Notes & avis</h2>

                <p class="muted">
                    Moyenne: {{ avgApproved }}/5
                    <span aria-hidden="true" class="stars">
                        {% for i in 1..5 %}{% if i <= avgApproved %}‚òÖ{% else %}‚òÜ{% endif %}{% endfor %}
                    </span>
                    <small class="muted">({{ countApproved }} avis)</small>
                </p>

                {% set visibleCount = 0 %}
                <div class="stack-md">
                    {% for review in recipe.reviews|default([]) %}
                        {% set canSee = review.isApproved or (app.user and (is_granted('ROLE_ADMIN') or review.author == app.user)) %}
                        {% if canSee %}
                            {% set visibleCount = visibleCount + 1 %}
                            <article class="surface rounded shadow" style="padding:12px">
                                <div>
                                    <strong>
                                        {% for i in 1..5 %}{% if i <= review.rating %}‚≠ê{% else %}‚òÜ{% endif %}{% endfor %}
                                    </strong>
                                    ‚Äî par {{ review.author.prenom ?? review.author.email }} ‚Ä¢ {{ review.createdAt|date('d/m/Y') }}
                                    {% if not review.isApproved %}
                                        <span class="badge bg-warning ms-2">En attente</span>
                                    {% endif %}
                                </div>

                                {% if review.comment %}
                                    <p style="margin:6px 0 0">{{ review.comment }}</p>
                                {% endif %}

                                {% if app.user and (review.author == app.user or is_granted('ROLE_ADMIN')) %}
                                    <div class="mt-2 d-flex gap-2">
                                        {% if is_granted('REVIEW_EDIT', review) %}
                                            <a class="btn btn-sm btn-outline-secondary"
                                               href="{{ path('app_review_edit', {id: review.id}) }}">Modifier</a>
                                        {% endif %}
                                        {% if is_granted('REVIEW_DELETE', review) %}
                                            <form method="post"
                                                  action="{{ path('app_review_delete', {id: review.id}) }}"
                                                  onsubmit="return confirm('Supprimer cet avis ?');">
                                                <input type="hidden" name="_token" value="{{ csrf_token('delete_review_' ~ review.id) }}">
                                                <button class="btn btn-sm btn-outline-danger">Supprimer</button>
                                            </form>
                                        {% endif %}
                                    </div>
                                {% endif %}
                            </article>
                        {% endif %}
                    {% endfor %}

                    {% if visibleCount == 0 %}
                        <p class="muted">Pas encore d‚Äôavis ‚Äî soyez le premier üçä</p>
                    {% endif %}
                </div>

                {# Formulaire d‚Äôavis #}
                <div class="mt-3 review-form">
                    {% if app.user %}
                        {% if form_review is defined %}
                            {% if alreadyRated %}
                                <div class="alert alert-info">Vous avez d√©j√† publi√© un avis pour cette recette.</div>
                            {% endif %}

                            {{ form_start(form_review, { action: path('app_review_new', { id: recipe.id }) }) }}
                            {% set field = form_review.rating %}

                            <div class="rating-field">
                                <label class="form-label">Votre note</label>
                                <div class="rating-stars">
                                    {% for i in 5..1 %}
                                        <input
                                            type="radio"
                                            id="{{ field.vars.id }}_{{ i }}"
                                            name="{{ field.vars.full_name }}"
                                            value="{{ i }}"
                                            {% if field.vars.value == i %}checked{% endif %}
                                        />
                                        <label for="{{ field.vars.id }}_{{ i }}" title="{{ i }} sur 5">‚òÖ</label>
                                    {% endfor %}
                                </div>
                                {{ form_errors(field) }}
                            </div>

                            {% if not is_granted('ROLE_ADMIN') %}
                                <p class="muted" style="margin-top:8px">
                                    üïí Votre avis sera visible apr√®s validation par un administrateur.
                                </p>
                            {% endif %}

                            <div class="review-comment">
                                {{ form_widget(form_review.comment, {
                                    attr: { class: 'review-textarea', placeholder: 'Quelques mots sur la recette‚Ä¶' }
                                }) }}
                                {{ form_errors(form_review.comment) }}
                            </div>

                            <button class="btn btn-primary review-submit">Publier mon avis</button>
                            {{ form_rest(form_review) }}
                            {{ form_end(form_review) }}
                        {% else %}
                            <div class="alert alert-warning d-flex justify-content-between align-items-center">
                                Le formulaire d‚Äôavis n‚Äôest pas disponible pour le moment.
                                <button type="button" class="btn btn-light" onclick="location.reload()">Recharger</button>
                            </div>
                        {% endif %}
                    {% else %}
                        <div class="alert alert-info">
                            Connectez-vous pour laisser un avis.
                            <a class="btn btn-sm btn-primary" href="{{ path('app_login') }}">Se connecter</a>
                        </div>
                    {% endif %}
                </div>
            </section>
        </div>
    </div>

    <style>
        .recipe-detail{max-width:900px;margin:0 auto}
        .recipe-header{display:grid;grid-template-columns:1fr 1fr;gap:40px;margin-bottom:30px;background:#fff;border-radius:15px;overflow:hidden;box-shadow:0 8px 25px rgba(0,0,0,.1)}
        .recipe-image-large{position:relative;height:400px}
        .recipe-image-large img{width:100%;height:100%;object-fit:cover}
        .recipe-placeholder-large{width:100%;height:100%;display:flex;align-items:center;justify-content:center;background:linear-gradient(135deg,#ff9800,#f57c00);font-size:6em;color:#fff}
        .recipe-overlay{position:absolute;top:20px;right:20px}
        .recipe-info{padding:40px;display:flex;flex-direction:column;justify-content:center}
        .recipe-info h1{font-size:2.2em;color:#ff9800;margin-bottom:15px}
        .recipe-description{font-size:1.1em;color:#666;margin-bottom:25px;line-height:1.6}
        .recipe-meta-large{display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:25px}
        .meta-item{display:flex;align-items:center;gap:10px;padding:15px;background:#fff8f0;border-radius:8px;border-left:4px solid #ff9800}
        .meta-icon{font-size:1.5em}
        .meta-item strong{display:block;font-size:1.2em;color:#ff9800}
        .meta-item small{color:#666;font-size:.9em}
        .recipe-author-info{display:flex;justify-content:space-between;padding-top:20px;border-top:2px solid #fff3e0;color:#666}

        .recipe-actions{background:#fff;padding:20px;border-radius:12px;margin-bottom:30px;display:flex;justify-content:space-between;align-items:center;box-shadow:0 4px 15px rgba(0,0,0,.1)}

        .recipe-content{display:grid;grid-template-columns:1fr 2fr;gap:40px;margin-bottom:40px}
        .recipe-ingredients,.recipe-instructions{background:#fff;padding:30px;border-radius:12px;box-shadow:0 4px 15px rgba(0,0,0,.1)}
        .recipe-ingredients h2,.recipe-instructions h2{color:#ff9800;margin-bottom:20px;font-size:1.5em;border-bottom:2px solid #fff3e0;padding-bottom:10px}
        .ingredient-item{display:flex;align-items:center;gap:10px;padding:8px 0;border-bottom:1px solid #f5f5f5}
        .ingredient-bullet{font-size:.8em}
        .instruction-step{display:flex;gap:15px;margin-bottom:20px;padding-bottom:20px;border-bottom:1px solid #f5f5f5}
        .step-number{flex-shrink:0;width:30px;height:30px;background:#ff9800;color:#fff;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:bold}
        .step-content{flex:1;line-height:1.6}

        /* --- Section avis --- */
        .review-section h2{margin:0 0 8px}
        .review-section .muted{margin:6px 0 14px}
        .stars{margin-left:6px}

        .review-form{
            background:#fff;border:1px solid var(--oc-border, #ece7e2);
            padding:16px 18px;border-radius:14px;box-shadow:0 6px 16px rgba(0,0,0,.06);
        }

        .form-label{font-weight:700;color:#23262B;margin:6px 0 8px;display:block}

        .rating-field{margin:12px 0 10px}
        .rating-stars{display:flex;gap:8px;flex-direction:row-reverse;align-items:center}
        .rating-stars input{position:absolute;left:-9999px}
        .rating-stars label{
            font-size:28px;line-height:1;cursor:pointer;color:#d6d6d6;
            user-select:none;transition:transform .15s ease, color .15s ease;
        }
        .rating-stars input:checked ~ label,
        .rating-stars label:hover,
        .rating-stars label:hover ~ label{ color:#ff9800; transform:translateY(-1px); }

        .review-textarea{
            width:100%;max-width:560px;min-height:120px;padding:12px 14px;
            border:1.5px solid var(--oc-border, #ece7e2);border-radius:12px;
            resize:vertical;background:#fff;font-size:16px;line-height:1.5;
            box-shadow: inset 0 2px 10px rgba(0,0,0,.03);
        }
        .review-textarea::placeholder{ color:#9aa3b2; }
        .review-textarea:focus{
            outline:0;border-color:var(--oc-orange, #ff9800);
            box-shadow:0 0 0 3px rgba(255,152,0,.12);background:#FFF7EB;
        }

        .review-submit{margin-top:10px}

        @media (max-width:768px){
            .recipe-header{grid-template-columns:1fr}
            .recipe-image-large{height:250px}
            .recipe-content{grid-template-columns:1fr}
            .recipe-meta-large{grid-template-columns:1fr;gap:10px}
            .recipe-actions{flex-direction:column;gap:15px;align-items:stretch}
        }
    </style>
{% endblock %}
