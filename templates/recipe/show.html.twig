{% extends 'base.html.twig' %}

{% block title %}{{ recipe.title }} - Orange Chef{% endblock %}

{% block meta %}
    {# URLs absolues #}
    {% set pageUrl  = absolute_url(path('app_recipe_show', { id: recipe.id })) %}
    {% set imageUrl = recipe.image
        ? absolute_url(asset((recipe.image starts with('http') or recipe.image starts with('https'))
        ? recipe.image
        : (recipe.image starts with('/uploads/') ? recipe.image
        : (recipe.image matches '/^uploads\\//' ? asset(recipe.image) : 'uploads/recipes/' ~ recipe.image)
        )))
        : absolute_url(asset('images/og-default.jpg')) %}

    {# Description courte et propre #}
    {% set rawDesc = recipe.description|default('') %}
    {% set desc    = (rawDesc|striptags)|u.truncate(160, '‚Ä¶') %}

    <link rel="canonical" href="{{ pageUrl }}">
    <meta property="og:type" content="article">
    <meta property="og:title" content="{{ recipe.title }}">
    <meta property="og:description" content="{{ desc }}">
    <meta property="og:url" content="{{ pageUrl }}">
    <meta property="og:image" content="{{ imageUrl }}">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="{{ recipe.title }}">
    <meta name="twitter:description" content="{{ desc }}">
    <meta name="twitter:image" content="{{ imageUrl }}">

    {# Normalisation des listes pour le JSON-LD (string -> array par \n) #}
    {% set rawIngredients = recipe.ingredients|default('') %}
    {% set ingredients    = rawIngredients is iterable ? rawIngredients : rawIngredients|split('\n')|filter(v => v|trim != '') %}

    {% set rawSteps = recipe.instructions|default('') %}
    {% set steps    = rawSteps is iterable ? rawSteps : rawSteps|split('\n')|filter(v => v|trim != '') %}

    {# JSON-LD fiable via json_encode #}
    {% set ld = {
        '@context': 'https://schema.org',
        '@type': 'Recipe',
        'name': recipe.title|default(''),
        'description': rawDesc|striptags|default(''),
        'image': [ imageUrl ],
        'recipeIngredient': ingredients,
        'recipeInstructions': steps|map(s => {'@type':'HowToStep','text': s|striptags })
    } %}

    <script type="application/ld+json">{{ ld|json_encode(constant('JSON_UNESCAPED_UNICODE'))|raw }}</script>
{% endblock %}


{% block body %}
    {% set _ingredients = ingredients|default([]) %}
    {% set _steps = steps|default([]) %}



      <div class="container">
        <div class="recipe-detail">
            <!-- En-t√™te recette -->
            <div class="recipe-header">
                <div class="recipe-image-large">
                    {% if recipe.image %}
                        {% set img = recipe.image %}
                        {% if img starts with 'http' or img starts with 'https' %}
                            {% set src = img %}
                        {% elseif img starts with 'uploads/' %}
                            {% set src = asset(img) %}
                        {% elseif img starts with '/uploads/' %}
                            {% set src = img %}
                        {% else %}
                            {% set src = asset('uploads/recipes/' ~ img) %}
                        {% endif %}
                        <img src="{{ src }}" alt="{{ recipe.title }}" loading="lazy" width="900" height="600">
                    {% else %}
                        <div class="recipe-placeholder-large">üçä</div>
                    {% endif %}

                    <div class="recipe-overlay">
                        <div class="recipe-badges">
                            <span class="badge badge-chef">{{ recipe.categoryIcon }} {{ recipe.category|title }}</span>
                            <span class="badge badge-bronze">{{ recipe.difficultyIcon }} {{ recipe.difficulty|title }}</span>
                        </div>
                    </div>
                </div>

                <div class="recipe-info">
                    <h1>{{ recipe.title }}</h1>
                    <p class="recipe-description">{{ recipe.description }}</p>

                    <div class="recipe-meta-large">
                        <div class="meta-item">
                            <span class="meta-icon">‚è±Ô∏è</span>
                            <div><strong>{{ recipe.totalTime }} min</strong><small>Total</small></div>
                        </div>
                        <div class="meta-item">
                            <span class="meta-icon">üë•</span>
                            <div><strong>{{ recipe.servings }}</strong><small>Portions</small></div>
                        </div>
                        <div class="meta-item">
                            <span class="meta-icon">üëÅÔ∏è</span>
                            <div><strong>{{ recipe.views }}</strong><small>Vues</small></div>
                        </div>
                        <div class="meta-item">
                            <span class="meta-icon">‚≠ê</span>
                            <div>
                                <strong>{{ avgApproved > 0 ? avgApproved : 'N/A' }}</strong>
                                <small>Note ({{ countApproved }})</small>
                            </div>
                        </div>
                    </div>

                    <div class="recipe-author-info">
                        <span>Par <strong>{{ recipe.author.displayName }}</strong></span>
                        <span class="recipe-date">{{ recipe.createdAt|date('d/m/Y') }}</span>
                    </div>

                    {% if app.user %}
                        <div class="mt-2">
                            <form method="post"
                                  action="{{ path('app_favorite_toggle', { _locale: app.request.locale, id: recipe.id }) }}">
                                <input type="hidden" name="_token" value="{{ csrf_token('fav_' ~ recipe.id) }}">
                                <input type="hidden" name="return" value="{{ app.request.uri }}">
                                <button class="btn {{ isFav ? 'btn-secondary' : 'btn-primary' }}">
                                    {{ isFav ? 'üíî Retirer des favoris' : '‚ù§Ô∏è Ajouter aux favoris' }}
                                </button>
                            </form>

                        </div>
                    {% endif %}
                </div>
            </div>

            {# Actions auteur/admin #}
            {% if app.user %}
                <div class="recipe-actions">
                    {% if app.user == recipe.author or is_granted('ROLE_ADMIN') %}
                        <a href="{{ path('app_recipe_edit', {id: recipe.id}) }}" class="btn btn-secondary">‚úèÔ∏è Modifier</a>
                        <form method="post" action="{{ path('app_recipe_delete', {id: recipe.id}) }}" style="display:inline">
                            <input type="hidden" name="_token" value="{{ csrf_token('delete' ~ recipe.id) }}">
                            <button type="submit" class="btn btn-danger" onclick="return confirm('√ätes-vous s√ªr de vouloir supprimer cette recette ?')">üóëÔ∏è Supprimer</button>
                        </form>
                    {% endif %}
                </div>
            {% endif %}

            <!-- Contenu principal -->
            <div class="recipe-content">
                <div class="recipe-ingredients">
                    <h2>ü•Ñ Ingr√©dients</h2>
                    <div class="ingredients-list">
                        {% for line in _ingredients %}
                            {% if line|trim %}
                                <div class="ingredient-item">
                                    <span class="ingredient-bullet">üçä</span>{{ line|trim }}
                                </div>
                            {% endif %}
                        {% endfor %}
                    </div>
                </div>

                <div class="recipe-instructions">
                    <h2>üë®‚Äçüç≥ Instructions</h2>
                    <div class="instructions-list">
                        {% set stepNumber = 1 %}
                        {% for line in _steps %}
                            {% if line|trim %}
                                <div class="instruction-step">
                                    <div class="step-number">{{ stepNumber }}</div>
                                    <div class="step-content">{{ line|trim }}</div>
                                </div>
                                {% set stepNumber = stepNumber + 1 %}
                            {% endif %}
                        {% endfor %}
                    </div>
                </div>
            </div>

            {# Partage #}
            {% include '_partials/share.html.twig' with { recipe: recipe } %}

            <!-- Notes et avis -->
            <section class="review-section mt-4" id="reviews">
                <h2>Notes et avis</h2>

                <p class="muted">
                    Moyenne: {{ avgApproved }}/5
                    <span aria-hidden="true" class="stars">
                        {% for i in 1..5 %}{% if i <= avgApproved %}‚òÖ{% else %}‚òÜ{% endif %}{% endfor %}
                    </span>
                    <small class="muted">({{ countApproved }} avis)</small>
                </p>

                {% set visibleCount = 0 %}
                <div class="stack-md">
                    {% for review in recipe.reviews|default([]) %}
                        {% set canSee = review.isApproved or (app.user and (is_granted('ROLE_ADMIN') or review.author == app.user)) %}
                        {% if canSee %}
                            {% set visibleCount = visibleCount + 1 %}
                            <article class="surface rounded shadow" style="padding:12px">
                                <div>
                                    <strong>
                                        {% for i in 1..5 %}{% if i <= review.rating %}‚≠ê{% else %}‚òÜ{% endif %}{% endfor %}
                                    </strong>
                                    ‚Äî par {{ review.author.prenom ?? review.author.email }} ‚Ä¢ {{ review.createdAt|date('d/m/Y') }}
                                    {% if not review.isApproved %}
                                        <span class="badge bg-warning ms-2">En attente</span>
                                    {% endif %}
                                </div>

                                {% if review.comment %}
                                    <p style="margin:6px 0 0">{{ review.comment }}</p>
                                {% endif %}

                                {% if app.user and (review.author == app.user or is_granted('ROLE_ADMIN')) %}
                                    <div class="mt-2 d-flex gap-2">
                                        {% if is_granted('REVIEW_EDIT', review) %}
                                            <a class="btn btn-sm btn-outline-secondary"
                                               href="{{ path('app_review_edit', {id: review.id}) }}">Modifier</a>
                                        {% endif %}
                                        {% if is_granted('REVIEW_DELETE', review) %}
                                            <form method="post"
                                                  action="{{ path('app_review_delete', {id: review.id}) }}"
                                                  onsubmit="return confirm('Supprimer cet avis ?');">
                                                <input type="hidden" name="_token" value="{{ csrf_token('delete_review_' ~ review.id) }}">
                                                <button class="btn btn-sm btn-outline-danger">Supprimer</button>
                                            </form>
                                        {% endif %}
                                    </div>
                                {% endif %}
                            </article>
                        {% endif %}
                    {% endfor %}

                    {% if visibleCount == 0 %}
                        <p class="muted">Pas encore d‚Äôavis ‚Äî soyez le premier üçä</p>
                    {% endif %}
                </div>

                {# Formulaire d‚Äôavis #}
                <div class="mt-3 review-form">
                    {% if app.user %}
                        {% if form_review is defined %}
                            {% if alreadyRated %}
                                <div class="alert alert-info">Vous avez d√©j√† publi√© un avis pour cette recette.</div>
                            {% endif %}

                            {{ form_start(form_review, { action: path('app_review_new', { id: recipe.id }) }) }}
                            {% set field = form_review.rating %}

                            <fieldset class="rating-field">
                                <legend class="form-label">Votre note</legend>

                                <div class="rating-stars">
                                    {# 5 -> 1 pour la coloration en row-reverse #}
                                    {% for i in 5..1 %}
                                        <input
                                            type="radio"
                                            id="{{ field.vars.id }}_{{ i }}"
                                            name="{{ field.vars.full_name }}"
                                            value="{{ i }}"
                                            {% if field.vars.value == i %}checked{% endif %}
                                        >
                                        <label for="{{ field.vars.id }}_{{ i }}" title="{{ i }} sur 5">‚òÖ</label>
                                    {% endfor %}
                                </div>

                                {{ form_errors(field) }}
                            </fieldset>


                            {% if not is_granted('ROLE_ADMIN') %}
                                <p class="muted" style="margin-top:8px">
                                    üïí Votre avis sera visible apr√®s validation par un administrateur.
                                </p>
                            {% endif %}

                            <div class="review-comment">
                                {{ form_widget(form_review.comment, {
                                    attr: { class: 'review-textarea', placeholder: 'Quelques mots sur la recette‚Ä¶' }
                                }) }}
                                {{ form_errors(form_review.comment) }}
                            </div>

                            <button class="btn btn-primary review-submit">Publier mon avis</button>
                            {{ form_rest(form_review) }}
                            {{ form_end(form_review) }}
                        {% else %}
                            <div class="alert alert-warning d-flex justify-content-between align-items-center">
                                Le formulaire d‚Äôavis n‚Äôest pas disponible pour le moment.
                                <button type="button" class="btn btn-light" onclick="location.reload()">Recharger</button>
                            </div>
                        {% endif %}
                    {% else %}
                        <div class="alert alert-info">
                            Connectez-vous pour laisser un avis.
                            <a class="btn btn-sm btn-primary" href="{{ path('app_login') }}">Se connecter</a>
                        </div>
                    {% endif %}
                </div>
            </section>
        </div>
    </div>


{% endblock %}
