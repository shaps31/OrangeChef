{# templates/base.html.twig #}
<!DOCTYPE html>
<html lang="{{ app.request.locale|default('fr') }}">
<head>
    <meta charset="UTF-8">

    {#  SEO / Open Graph  #}
    <meta property="og:type" content="website">
    <meta property="og:site_name" content="Orange Chef">
    <meta property="og:title" content="{% block og_title %}{{ block('title') }}{% endblock %}">
    <meta property="og:description" content="Recettes ensoleillées, astuces anti-gaspi et fraîcheur vitaminée.">
    <meta property="og:image" content="{{ asset('images/og-default.jpg') }}">
    <meta property="og:url" content="{{ app.request.uri|default('') }}">
    <meta name="twitter:card" content="summary_large_image">

    <title>{% block title %}Orange Chef{% endblock %}</title>

    {# --- Favicon & icons --- #}
    <link rel="icon" href="{{ asset('favicon.svg') }}?v=2" type="image/svg+xml">
    <link rel="icon" href="{{ asset('favicon-32.png') }}?v=2" sizes="32x32" type="image/png">
    <link rel="shortcut icon" href="{{ asset('favicon-32.png') }}?v=2"> {# vieux navigateurs #}
    <link rel="apple-touch-icon" href="{{ asset('apple-touch-icon.png') }}?v=2">


    {# --- Bootswatch + Icons (optionnels) --- #}
    <link href="https://cdn.jsdelivr.net/npm/bootswatch@5.3.3/dist/litera/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">

    {% block stylesheets %}
        {{ importmap('app') }}
        <link rel="stylesheet" href="{{ asset('styles/theme-citrus.css') }}">

    {% endblock %}

    {% block meta %}{% endblock %}

</head>


<body data-help-kb-url="{{ path('app_contact', {'_locale': app.request.locale}) }}">
<header class="main-header">
    <div class="header-container">
        <div class="logo-section">
            <a href="{{ path('app_home', {'_locale': app.request.locale}) }}" class="logo-link" aria-label="Orange Chef">
                <picture>
                    <source srcset="{{ asset('images/logo-nav.svg') }}" media="(prefers-color-scheme: dark)">
                    <img src="{{ asset('images/logo-nav.svg') }}"
                         alt="Orange Chef"
                         width="40" height="40"
                         style="height:36px;width:auto;display:block"
                         decoding="async" fetchpriority="high">
                </picture>
                <span class="logo-text">Orange Chef</span>
            </a>
        </div>

        <div class="header-actions">
            {# Changer de langue #}
            {% set currentRoute  = app.request.attributes.get('_route')|default('app_home') %}
            {% set currentParams = app.request.attributes.get('_route_params')|default({}) %}
            {% if currentParams is not iterable %}{% set currentParams = {} %}{% endif %}

            <div class="language-switcher">
                {% for lang in ['fr','en'] %}
                    {% if app.request.locale == lang %}
                        <span class="lang-active">{{ lang == 'fr' ? '🇫🇷' : '🇬🇧' }}</span>
                    {% else %}
                        <a href="{{ path(currentRoute, currentParams|merge({'_locale': lang})) }}"
                           class="lang-link">
                            {{ lang == 'fr' ? '🇫🇷' : '🇬🇧' }}
                        </a>
                    {% endif %}
                {% endfor %}
            </div>

            {# --- Utilisateur --- #}
            {% if app.user %}
                <div class="user-section">
                    {% if app.user.avatar %}
                        <img src="{{ asset('uploads/avatars/' ~ app.user.avatar) }}?v={{ 'now'|date('U') }}" alt="Avatar" class="user-avatar">
                    {% else %}
                        <div class="user-avatar-default">👤</div>
                    {% endif %}
                    <div class="user-info">
                        <span class="user-name">{{ app.user.prenom ?? app.user.email }}</span>
                        <span class="user-role">{{ is_granted('ROLE_ADMIN') ? '👑 Admin' : '🙋 Utilisateur' }}</span>
                    </div>
                </div>
            {% endif %}
        </div>
    </div>
</header>

{# - NAV : bouton qui ouvre un panneau (dropdown global) -#}
<nav class="main-nav">
    <div class="nav-container">
        <button id="ocMenuToggle" class="btn btn-light" aria-expanded="false" aria-controls="ocMenuPanel">
            <span style="margin-right:.25rem">🍊</span> {{ 'nav.menu_button'|trans }}
            <span class="chev" aria-hidden="true" style="margin-left:.4rem">▾</span>
        </button>
    </div>

    <div id="ocMenuPanel" class="menu-panel" hidden>
        <div class="menu-grid">

            <section class="menu-group">
                <h3>{{ 'nav.browse'|trans }}</h3>
                <div class="links">
                    {% set route = app.request.attributes.get('_route') %}
                    <a href="{{ path('app_home', {'_locale': app.request.locale}) }}"
                       class="{{ route == 'app_home' ? 'is-active' : '' }}">{{ 'nav.home'|trans }}</a>

                    <a href="{{ path('app_recipe_index') }}"
                       class="{{ route starts with 'app_recipe_' ? 'is-active' : '' }}">{{ 'nav.recipes'|trans }}</a>

                    <a href="{{ path('app_contact') }}"
                       class="{{ route == 'app_contact' ? 'is-active' : '' }}">{{ 'nav.contact'|trans }}</a>

                </div>
            </section>

            <section class="menu-group">
                <h3>{{ 'nav.my_space'|trans }}</h3>
                {% if not app.user %}
                    <div class="links">
                        <a href="{{ path('app_login', {'_locale': app.request.locale}) }}">🔐 {{ 'login'|trans }}</a>
                        <a href="{{ path('app_register', {'_locale': app.request.locale}) }}">📝 {{ 'register'|trans }}</a>
                    </div>
                {% else %}
                    <div class="links">
                        <a href="{{ path('app_dashboard') }}">{{ 'nav.dashboard'|trans }}</a>
                        <a href="{{ path('app_my_recipes') }}">{{ 'nav.my_recipes'|trans }}</a>
                        <a href="{{ path('app_favorites', {'_locale': app.request.locale}) }}">{{ 'nav.favorites'|trans }}</a>
                        <a href="{{ path('app_inventory_index') }}">{{ 'nav.inventory'|trans }}</a>
                        <a href="{{ path('app_profil') }}">{{ 'nav.profile'|trans }}</a>
                        <a href="{{ path('app_logout', {'_locale': app.request.locale}) }}">{{ 'nav.logout'|trans }}</a>
                    </div>
                {% endif %}

            </section>

            {% if is_granted('ROLE_ADMIN') %}
                <section class="menu-group">
                    <h3>{{ 'nav.admin'|trans }}</h3>
                    <div class="links">
                        <a href="{{ path('app_user_index') }}">{{ 'nav.admin_users'|trans }}</a>
                        <a href="{{ path('app_admin_reviews') }}">
                            {{ 'nav.admin_reviews'|trans }}
                            {% set pending = pending_reviews() %}
                            {% if pending > 0 %}<span class="chip">{{ pending }}</span>{% endif %}
                        </a>
                    </div>

                </section>
            {% endif %}

            <section class="menu-group search">
                <h3>{{ 'nav.search'|trans }}</h3>
                <form action="{{ path('app_recipe_index', {'_locale': app.request.locale}) }}"
                      method="get"
                      class="search-form"
                      data-suggest-host> {# host relatif pour le dropdown #}

                    <input
                        type="text"
                        name="q"
                        value="{{ app.request.query.get('q') }}"
                        placeholder="{{ 'nav.search_placeholder'|trans }}"
                        autocomplete="off"
                        data-suggest-url="{{ path('app_search_suggest', {'_locale': app.request.locale}) }}"
                    >
                    <button type="submit">🔍</button>
                </form>
            </section>


        </div>
    </div>
</nav>

{# --- Flash messages --- #}
{% for type, messages in app.flashes %}
    {% for message in messages %}
        <div class="alert alert-{{ type }}">{{ message }}</div>
    {% endfor %}
{% endfor %}

<main class="main-content">
    <div class="content-container">
        {% block body %}{% endblock %}
    </div>
</main>

<footer class="main-footer">
    <div class="container py-1">
        <div class="d-flex flex-wrap align-items-center justify-content-between gap-3">

            {# gauche : logo + marque + année #}
            <div class="d-flex align-items-center gap-2">
                <img src="{{ asset('images/logo-nav.svg') }}" alt="Orange Chef"
                     width="24" height="24" style="height:24px;width:auto;display:block">
                <strong class="text-light">Orange Chef</strong>
                <span class="small text-light opacity-75">· © {{ "now"|date("Y") }}</span>
            </div>

            {# centre : liens courts #}
            <ul class="list-inline mb-0 small">
                <li class="list-inline-item"><a class="link-light text-decoration-none" href="{{ path('app_home', {'_locale': app.request.locale}) }}">Accueil</a></li>
                <li class="list-inline-item"><a class="link-light text-decoration-none" href="{{ path('app_recipe_index') }}">Recettes</a></li>
                <li class="list-inline-item"><a class="link-light text-decoration-none" href="/mentions-legales">Mentions</a></li>
                <li class="list-inline-item"><a class="link-light text-decoration-none" href="/cgu">CGU</a></li>
                <li class="list-inline-item"><a class="link-light text-decoration-none" href="{{ path('app_contact') }}">Contact</a></li>
            </ul>

            {# droite : réseaux sociaux #}
            <div class="d-flex align-items-center gap-2">
                <a class="icon-link link-light" href="#" aria-label="Instagram"><i class="bi bi-instagram"></i></a>
                <a class="icon-link link-light" href="#" aria-label="YouTube"><i class="bi bi-youtube"></i></a>
                <a class="icon-link link-light" href="#" aria-label="TikTok"><i class="bi bi-tiktok"></i></a>
            </div>
        </div>
    </div>
</footer>

{#Style Barre de Recherche#}
<style>
    .oc-suggest{position:absolute;top:100%;left:0;width:min(360px,92vw);background:#fff;border:1px solid #e5e7eb;border-radius:10px;box-shadow:0 10px 26px rgba(0,0,0,.12);margin-top:6px;z-index:9999;overflow:auto;max-height:300px}
    .oc-suggest ul{list-style:none;margin:0;padding:6px}
    .oc-suggest li{display:flex;align-items:center;gap:8px;padding:8px 10px;border-radius:8px;cursor:pointer}
    .oc-suggest li[aria-selected="true"],.oc-suggest li:hover{background:#fff7ed}
    .oc-suggest .type{font-size:12px;color:#9ca3af;margin-left:auto}
    .oc-suggest-host{position:relative} /* helper pour positionner le panneau */
</style>

<script>
    (() => {
        const debounce = (fn, ms=180) => { let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a),ms);} };

        function initSuggest(input){
            if (input.dataset.suggestReady) return; // idempotent
            input.dataset.suggestReady = '1';

            // Conteneur pour positionner le dropdown correctement
            let host = input.parentElement;
            if (!host) return;
            if (!host.classList.contains('oc-suggest-host')) {
                host.classList.add('oc-suggest-host');
                host.style.position = host.style.position || 'relative';
            }

            const url = input.dataset.suggestUrl;
            let panel, items = [], active = -1;

            function ensurePanel(){
                if (panel) return panel;
                panel = document.createElement('div');
                panel.className = 'oc-suggest';
                panel.hidden = true;
                panel.innerHTML = '<ul></ul>';
                host.appendChild(panel);
                return panel;
            }
            function show(){ ensurePanel(); panel.hidden = false; }
            function hide(){ if(panel){ panel.hidden = true; active = -1; } }
            function hasPanel(){ return panel && !panel.hidden; }

            function norm(json){
                const arr = Array.isArray(json) ? json : (Array.isArray(json.items) ? json.items : []);
                return arr.map(x => {
                    if (typeof x === 'string') return {label:x, type:'text', url:null};
                    return {label: x.label ?? '', type: x.type ?? 'text', url: x.url ?? null};
                }).filter(o => o.label);
            }

            function render(){
                ensurePanel();
                const ul = panel.querySelector('ul');
                if (!items.length){ ul.innerHTML=''; hide(); return; }
                ul.innerHTML = items.map((it,i)=>`
        <li role="option" data-idx="${i}" aria-selected="${i===active?'true':'false'}">
          <span>${(it.label||'').replace(/</g,'&lt;')}</span>
          ${it.type ? `<span class="type">${it.type}</span>` : ''}
        </li>
      `).join('');
                ul.querySelectorAll('li').forEach(li=>{
                    li.addEventListener('mousedown', (e)=>{ e.preventDefault(); choose(Number(li.dataset.idx)); });
                });
                show();
            }

            function choose(idx){
                const it = items[idx]; if(!it) return;
                if (it.url) { window.location.assign(it.url); }
                else { input.value = it.label; hide(); }
            }

            function move(dir){
                if(!items.length) return;
                active = (active + dir + items.length) % items.length;
                render();
            }

            const fetchIt = debounce(async ()=>{
                const q = input.value.trim();
                if (q.length < 2){ items=[]; render(); return; }
                try{
                    const res = await fetch(`${url}?q=${encodeURIComponent(q)}`, { headers:{'Accept':'application/json'} });
                    if (!res.ok){ items=[]; render(); return; }
                    items = norm(await res.json()).slice(0,10);
                    active = items.length ? 0 : -1;
                    render();
                }catch{ items=[]; render(); }
            }, 200);

            input.addEventListener('input', fetchIt);
            input.addEventListener('focus', ()=>{ if(items.length) show(); });
            input.addEventListener('blur', ()=> setTimeout(hide, 100));
            input.addEventListener('keydown', (e)=>{
                if (!hasPanel()) return;
                if (e.key==='ArrowDown'){ e.preventDefault(); move(+1); }
                else if (e.key==='ArrowUp'){ e.preventDefault(); move(-1); }
                else if (e.key==='Enter'){ if(active>=0){ e.preventDefault(); choose(active); } }
                else if (e.key==='Escape'){ hide(); }
            });

            document.addEventListener('mousedown', (e)=>{ if (!host.contains(e.target)) hide(); });
        }

        // auto-init sur toute la page (filtres + nav)
        document.querySelectorAll('input[data-suggest-url]').forEach(initSuggest);

        // si le markup est chargé dynamiquement, expose initSuggest globalement :
        window.OC_INIT_SUGGEST = initSuggest;
    })();
</script>


{% include '_partials/help_widget.html.twig' %}

</body>
</html>
